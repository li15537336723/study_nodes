## 6、四两拨千斤——HyperLogLog

业务场景统计 UV 数据

> uv：如果用户访问某个页面,然后浏览另外2个页面,离开您的网站并返回以查看更多页面,则该用户被视为1个UV

### 6.1 使用方法

HyperLogLog 提供两个指令 pfadd 和 pfcount，根据字面意思很好理解，一个是增加计数，一个是获取计数。pfadd 和 set 集合的用法是一样的，来一个用户ID，就将用户 ID 塞进去即可，pfcount 和 scard 的用法是一样的，直接获取计数值。

----

![image-20220921162609738](https://lixianghong.oss-cn-beijing.aliyuncs.com/typore/image-20220921162609738.png)

### 6.2 pfmerge 适合的场合

现有两个内容差不多的页面，如果要对这两个页面的数据进行合并，其中页面的 UV 访问量也需要合并，那么这个时候 pfmerge 就可以派上用场了



## 7、布隆过滤器

### 7.1 什么是布隆过滤器

可以把布隆过滤器理解为一个不怎么精确的 set 结构，当你使用它的 contains 方法判断某个对象是否存在时，他可能会误判。但是布隆过滤器也不是特别不精确，只要参数设置合理，它的精确度也可以控制得相对足够精确，只会有小小的误判概率

### 7.2 Redis 中的布隆过滤器

布隆过滤器作为一个插件加载到 Redis Server 中，给 Redis 提供了强大的布隆去重功能

### 7.3 布隆过滤器用法

布隆过滤器有两个基本指令，`bf.add` 和 `bf.exists`。`bf.add` 添加元素，`bf.exist` 查询元素是否存在，他们的用法和 set 集合的 `sadd` 和 `sismember` 差不多。添加多个指令：`bf.madd`，查询多个元素指令：`bf.mexists`



布隆过滤器有误判的可能性，可以通过修改参数来降低误判率。我们在 add 之前使用 bf.reserve 指令显式创建。如果对应的 key 已经存在，bf.reserve 会报错。bf.reserve 有三个参数，分别是 `key`，`error_rate(错误率)` 和 `initial_size` 

error_rate 越低，需要的空间越大

initial_size 表示预计放入的元素数量，当实际数量超出这个数值时，误判率会上升，所以需要提前设置一个较大的数值来避免超出导致误判率升高

默认值：error_rate：0.01		initial_size：100

### 7.4 注意事项

布隆过滤器的 initial_size 设置得过大，会浪费存储空间，设置得过小，会影响准确率
布隆过滤器的 error_rate 越小，需要的存储空间就越大，对于不需要过于精确的场合，error_rate 设置稍微大一点也无伤大雅

### 7.5 布隆过滤器原理

每个布隆过滤器对应到 Redis 的数据结构里面激素一个大型的位数组和几个不一样的无偏 hash 函数，如下图中的 f、g、h 

无偏：就是能够把元素的 hash 值算的比较均匀，让元素被 hash 映射到位数组中国的位置比较随机

![image-20220921172322546](https://lixianghong.oss-cn-beijing.aliyuncs.com/typore/image-20220921172322546.png)

**向布隆过滤器中添加 key**

添加 key 时会使用多个 hash 函数对 key 进行 hash，算得一个整数索引值，然后对位数组长度进行取模运算得到一个位置，每个 hash 函数都会算得一个不同的位置，再把位数组这几个位置都置为 1 就完成了 add 操作

**向布隆过滤器询问 key 是否存在**

与 add 一样，会把 hash 的几个位置都算出来，看看位数组中这几个位置是否都为 0，只要有一个位为0，那么说明这个布隆过滤器中这个 key 不存在，如果这几个位置都是1，并不能说明这个 key 就一定存在，只是极有可能存在，因为这些被置为1可能是因为其他的 key 存在所致。如果这个位数组比较稀疏，判断正确的概率就会很大，比较拥挤，判断概率会降低

在使用时不要让实际元素数量远大于初始化数量，当实际元素数量开始超初始化数量时，应该对布隆过滤器进行重建，重新分配一个 size 更大的过滤器，再将所有的李四元素批量 add 进去



## 8、限流

当系统的处理能力有限时，如何阻止计划外的请求继续对系统施压，这是一个需要重视的问题

### 8.1 如何使用 Redis 来实现简单限流策略

首先我们来看一个常见的，简单的限流策略。系统要限定用户的某个行为在指定时间里只允许发生 N 次，如何使用 Redis 的数据结构来实现这个限流的功能



### 8.2 解决方案

使用滑动时间窗口，用 zset 数据结构的 score 值可以通过 score 来圈出这个时间窗口来

<img src="C:\Users\李祥鸿\AppData\Roaming\Typora\typora-user-images\image-20220922164303103.png" alt="image-20220922164303103" style="zoom: 50%;" />





















































































































































































