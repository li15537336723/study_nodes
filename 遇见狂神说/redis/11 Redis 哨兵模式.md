## 哨兵模式

> 概述

当从切换技术的方法是：当主服务器宕机后，需要手动把一台从服务器切换为主服务器，这就需要人工干预，费时费力，还会造成一段时间内服务不可用。这不是一种推荐的方式，更多时候，我们优先考虑哨兵模式。Redis 从 2.8 开始正式提供了 Sentinel（哨兵）架构来解决这个问题。



谋朝篡位的自动版，能够后台监控主机是否故障，如果故障了根据投票数==自动将从库转换为主库==



哨兵模式是一种特殊的模式，首先 Redis 提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。其原理是 **哨兵通过发送命令，等待 Redis 服务器响应，从而监控运行的多个 Redis 实例**

<img src="C:\Users\李祥鸿\AppData\Roaming\Typora\typora-user-images\image-20210731154639323.png" alt="image-20210731154639323" style="zoom:67%;" />

这里的哨兵有两个作用

- 通过发送命令，让 Redis 服务器返回监控其运行状态，包括主服务器和从服务器
- 当哨兵检测到 master 宕机，会自动将 slave 切换成 master ，然后通过**发布 订阅模式** 通知其他的服务器，修改配置文件，让他们切换主机

然而一个哨兵进程对 Redis 服务器进行监控，可能会出现问题，为此，我们可以使用多个哨兵进行监控。各个哨兵之间还会进行监控，这样就形成了哨兵模式。

<img src="C:\Users\李祥鸿\AppData\Roaming\Typora\typora-user-images\image-20210731155008831.png" alt="image-20210731155008831" style="zoom: 50%;" />

假设主服务器宕机，哨兵 1 先检查到这个结果，系统并不会马上进行 failover 过程，仅仅是哨兵 1 主观的认为主服务器不可用，这个现象称为 **主观下线** 。当后面的哨兵也检测到主服务器不可用，并且达到一定值时，那么哨兵之间就会进行依次投票，投票的结果由一个哨兵发起，进行 failover [故障转移]操作。切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个称为**客观下线**



如果主机宕机之后再回来了，那么他只能归并的新的主机下，当作从机，这就是哨兵模式的规则！

> 哨兵模式

优点：

1、哨兵集群，基于主从复制模式，所有的主从配置优点，他全有

2、主从可以切换，故障可以转移，系统的可用性就会更好

3、哨兵模式就是主从模式的升级，手动到自动，更加健壮！

缺点：

1、Redis 不好在线扩容，集群容量一旦达到上限，在线扩容就十分麻烦！

2、实现哨兵模式的配置是很麻烦的，里面有很多选择！































































