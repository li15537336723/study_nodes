# 25 | MySQL是怎么保证高可用的？

### 主备延迟

主备切换可能是一个主动运维动作，比如软件升级、主库所在机器按计划下线等，也可能是被动操作，比如主库所在机器掉电。

主动切换的场景。与数据同步有关的时间点主要包括以下三个：

1. 主库 A 执行完成一个事务，写入 binlog，我们把这个时刻记为 T1；
2. 之后传给备库 B，我们把备库 B 接收完这个 binlog 的时刻记为 T2；
3. 备库 B 执行完成这个事务，我们把这个时刻记为 T3。

所谓主备延迟，就是同一个事务，在备库执行完成时间和主库执行完成时间之间的差值，也就是 T3 - T1



### 主备延迟的来源

**首先，有些部署条件下，备注所在机器的性能要比主库所在的机器性能差**



**第二种：备库的压力大**

一般情况下，主库既然提供了写的能力，那么备库可以提供一些读能力。或者一些运营后台需要的分析语句，不能影响正常业务，所以只能在备库上跑。

有些时候，会认为由于主库直接影响业务，大家使用起来比较克制，反而忽视了备库的压力控制。结果就是，备库上的擦汗寻消耗了大量的 CPU 资源，影响了同步速度，造成了主备延迟。

出现这种情况，一般可以这样处理：

1. 一主多从。除了备库外，可以多接几个从库，让这些从库来分担读的压力。
2. 通过 binlog 输出到外部系统，比如 Hadoop 这类系统，让外部系统提供统计类查询能力。

其中，一主多从的方式大都会背采用。因为作为数据系统，还必须保证定期全量备份的能力。而从库，就很适合用来作备份。



**第三种：大事务**

大事务这种情况，因为主库上必须等事务执行完才会写入 binlog，再传给备库。所以，如果一个主库上的语句执行 10 分钟，那这个事务很有可能就会导致从库延迟 10 分钟。

在主从库中，**不要一次性的用 delete 语句删除太多数据**。

**另一种典型大事务场景，就是大表 DDL**。



### 可靠性优先策略

![image-20220323090549859](https://lixianghong.oss-cn-beijing.aliyuncs.com/typore/image-20220323090549859.png)

上图中，双 M 结构下，从状态 1 到状态 2 切换的详细过程如下：

1. 判断备库 B 现在的 seconds_bind_master，如果小于某个值（比如 5 秒）继续下一步，否则持续重试这一步；
2. 把主库 A 改成只读状态，即把 readonly 设置为 true；
3. 判断备库 B 的 seconds_behid_master 的值，直到这个值变成 0 为止；
4. 把备库 B 改成刻度写状态，也就是把 readonly 设置为 false
5. 把业务请求到备库 B。

**流程切换如下：**

![image-20220323091037420](https://lixianghong.oss-cn-beijing.aliyuncs.com/typore/image-20220323091037420.png)



### 可用性优先策略

如果我们强行把步骤 4、5 调整到最后开始执行，也就是说不等主备数据同步，直接把连接切到备库 B，并且让备库 B 可以读写，那么系统几乎就没有不可用时间了。

我们把这个切换流程，暂时称为可用性优先流程。这个切换流程的代价，就是可能出现数据不一致的情况。



举例：

假设有一个表 t 

```sql
 mysql> CREATE TABLE`t` (
    `id` int(11) unsigned NOT NULL AUTO_ INCREMENT,
    `c` int(11) unsigned DEFAULT NULL,
	PRIMARY KEY ( `id` )
) ENGINE=InnoDB;
insert into t(c) values(1),(2),(3);
```

这个表定义了一个自增主键id，初始化数据口，主库和备库上都有 3 行数据，接下来，业务人员要继续在表 t 上执行两条插入语句的命令，依次是：

```sql
insert into t(c) values(4);
insert into t(c) values(5);
```

假设，现在在主库上其他的数据表大量的更新操作，导致主备延迟达到 5 秒，在插入一条 c = 4 的语句之后，发起了主备切换。

<img src="https://lixianghong.oss-cn-beijing.aliyuncs.com/typore/image-20220323093441633.png" alt="image-20220323093441633" style="zoom:67%;" />

![image-20220323093515130](https://lixianghong.oss-cn-beijing.aliyuncs.com/typore/image-20220323093515130.png)



主备切换的可用性优先策略会导致数据不一致，因此，大多数情况下，建议使用可靠性优先测试。毕竟对于服务来说，数据的可靠性一般要优于可用性的。





















































































































































































































